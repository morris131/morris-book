---
title: 访问者模式
date: 2018-12-11
categories: 设计模式
tags: [设计模式,访问者模式]
---

# 访问者模式

## 定义
访问者模式（Visitor Pattern）：封装一些作用于某种数据结构中的各元素的操作，它可以在不改变数据结构的前提下定义作用于这些元素的新的操作。

## 类图
![访问者模式类图]()

在访问者模式类图中包含如下几个角色：
- Vistor（抽象访问者）：抽象访问者为对象结构中每一个具体元素类 ConcreteElement 声明一个访问操作，从这个操作的名称或参数类型可以清楚知道需要访问的具体元素的类型，具体访问者需要实现这些操作方法，定义对这些元素的访问操作。
- ConcreteVisitor（具体访问者）：具体访问者实现了每个由抽象访问者声明的操作，每一个操作用于访问对象结构中一种类型的元素。
- Element（抽象元素）：抽象元素一般是抽象类或者接口，它定义一个 accept() 方法，该方法通常以一个抽象访问者作为参数。
- ConcreteElement（具体元素）：具体元素实现了 accept() 方法，在 accept() 方法中调用访问者的访问方法以便完成对一个元素的操作。
- ObjectStructure（对象结构）：对象结构是一个元素的集合，它用于存放元素对象，并且提供了遍历其内部元素的方法。它可以结合组合模式来实现，也可以是一个简单的集合对象，如一个 List 对象或一个 Set 对象。

## 实现
[Flyweight.java](https://github.com/morris131/morris-book/tree/master/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/Java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/pattern/src/main/java/com/morris/pattern/flyweight/impl/Flyweight.java)
```java
package com.morris.pattern.flyweight.impl;

public abstract class Flyweight {
    /**
     * 外部状态在使用时由外部设置，不保存在享元对象中，即使是同一个对象，在每一次调用时也可以传入不同的外部状态
     * @param extrinsicState 外部状态
     */
    protected abstract void operation(String extrinsicState);
}
```
[ConcreteFlyweight.java](https://github.com/morris131/morris-book/tree/master/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/Java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/pattern/src/main/java/com/morris/pattern/flyweight/impl/ConcreteFlyweight.java)
```java
package com.morris.pattern.flyweight.impl;

public class ConcreteFlyweight extends Flyweight {

    /**
     * 内部状态，同一个享元对象其内部状态是一致的
     */
    private String intrinsicState;

    public ConcreteFlyweight(String intrinsicState) {
        this.intrinsicState = intrinsicState;
    }

    @Override
    protected void operation(String extrinsicState) {
        System.out.println("Intrinsic State = " + this.intrinsicState);
        System.out.println("Extrinsic State = " + extrinsicState);
    }

}
```
[FlyweightFactory.java](https://github.com/morris131/morris-book/tree/master/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/Java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/pattern/src/main/java/com/morris/pattern/flyweight/impl/FlyweightFactory.java)
```java
package com.morris.pattern.flyweight.impl;

import java.util.HashMap;

public class FlyweightFactory {

    private HashMap<String, Flyweight> pool = new HashMap<>();

    public Flyweight getFlyweight(String intrinsicState) {
        if(pool.containsKey(intrinsicState)) {
            return pool.get(intrinsicState);
        } else {
            return new ConcreteFlyweight(intrinsicState);
        }
    }
}
```
[Client.java](https://github.com/morris131/morris-book/tree/master/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/Java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/pattern/src/main/java/com/morris/pattern/flyweight/impl/Client.java)
```java
package com.morris.pattern.flyweight.impl;

public class Client {

    public static void main(String[] args) {
        FlyweightFactory factory = new FlyweightFactory();
        Flyweight fly = factory.getFlyweight("a");
        fly.operation("First Call");

        fly = factory.getFlyweight("b");
        fly.operation("Second Call");

        fly = factory.getFlyweight("c");
        fly.operation("Third Call");
    }

}
```

## 优点
- 可以极大减少内存中对象的数量，使得相同或相似对象在内存中只保存一份，从而可以节约系统资源，提高系统性能。
- 外部状态相对独立，而且不会影响其内部状态，从而使得享元对象可以在不同的环境中被共享。

## 缺点
- 使得系统变得复杂，需要分离出内部状态和外部状态，这使得程序的逻辑复杂化。
- 为了使对象可以共享，需要将享元对象的部分状态外部化，而读取外部状态将使得运行时间变长。

## 适用场景
- 一个系统有大量相同或者相似的对象，造成内存的大量耗费。
- 对象的大部分状态都可以外部化，可以将这些外部状态传入对象中。
- 需要缓冲池的场景